<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英語→日本語 小テスト</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="number"] { width: 90px; padding: 6px; font-size: 16px; }
    input[type="text"] { width: min(520px, 90vw); padding: 10px; font-size: 18px; }
    button { padding: 8px 12px; font-size: 16px; }
    #word { font-size: 22px; margin: 14px 0; }
    #rangeinfo { margin: 10px 0; color: #333; }
    #result { margin-top: 10px; font-size: 18px; }
  </style>
</head>
<body>
  <h1>英語→日本語 小テスト</h1>

  <div class="row">
    範囲：
    <input id="start" type="number" value="1" min="1" />
    〜
    <input id="end" type="number" value="2000" min="1" />
    <button id="btnLoad">この範囲で開始</button>
  </div>

  <div id="rangeinfo"></div>

  <div id="word">loading...</div>

  <div class="row">
    <input id="answer" type="text" placeholder="日本語で入力" />
    <button id="btnCheck">判定</button>
    <button id="btnNext">次へ</button>
  </div>

  <div id="result"></div>

<script>
let vocab = [];
let current = null;

function getRange() {
  const s = Number(document.getElementById("start").value);
  const e = Number(document.getElementById("end").value);
  return { start: s, end: e };
}

async function loadRange() {
  const { start, end } = getRange();
  const r = await fetch(`/vocab?start=${start}&end=${end}`);
  vocab = await r.json();

  document.getElementById("rangeinfo").textContent =
    `読み込み完了：${start}〜${end}（${vocab.length}語）`;

  if (vocab.length === 0) {
    document.getElementById("word").textContent = "単語がありません";
    current = null;
    return;
  }
  nextQ();
}

function nextQ() {
  if (!vocab.length) return;
  current = vocab[Math.floor(Math.random() * vocab.length)];
  document.getElementById("word").textContent = current.en;
  document.getElementById("answer").value = "";
  document.getElementById("result").textContent = "";
  document.getElementById("answer").focus();
}

async function check() {
  if (!current) return;

  const user = document.getElementById("answer").value;

  const r = await fetch("/check", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: current.id, user })
  });

  const d = await r.json();
  document.getElementById("result").textContent =
    (d.correct ? "〇 正解" : "× 正解：") + (d.correct ? "" : (d.correct_examples || []).join(" / "));
}

document.getElementById("btnLoad").addEventListener("click", loadRange);
document.getElementById("btnNext").addEventListener("click", nextQ);
document.getElementById("btnCheck").addEventListener("click", check);

// Enter で判定、Shift+Enter で次へ（スマホでも使いやすい）
document.getElementById("answer").addEventListener("keydown", (ev) => {
  if (ev.key === "Enter" && !ev.shiftKey) { ev.preventDefault(); check(); }
  if (ev.key === "Enter" && ev.shiftKey) { ev.preventDefault(); nextQ(); }
});

// 最初は 1〜2000 を読み込む
loadRange();
</script>
</body>
</html>
